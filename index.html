<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Teste Registo Cagarros</title>
</head>
<body>
  <h1>Teste Registo Cagarros</h1>

  <form id="formRegisto">
    <label>
      Nome do voluntário:
      <input type="text" id="nome" required />
    </label><br><br>

    <label>
      Estado da ave:
      <select id="estado" required>
        <option value="">-- Escolha --</option>
        <option value="vivo">Vivo</option>
        <option value="ferido">Ferido</option>
        <option value="morto">Morto</option>
        <option value="sujo com óleo">Sujo com óleo</option>
        <option value="não sei descrever">Não sei descrever</option>
      </select>
    </label><br><br>

    <button type="submit">Registar</button>
  </form>

  <div id="resultado" style="margin-top:20px; font-weight:bold;"></div>

  <script>
    const form = document.getElementById('formRegisto');
    const resultado = document.getElementById('resultado');

    // Substitui pelo teu URL do Web App
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxwPOFIUAMXRZePWrVJPLijUhPK1E9wsMs1cJ1ZNFraWn4B7SJSbVHKgAPQPVBIt86D/exec";

    // Função para calcular fase da lua (simplificada)
    function getMoonPhase() {
      const now = new Date();
      const diff = (now - new Date("2001-01-01")) / 86400000;
      const phase = diff % 29.53;

      const phases = [
        "Lua Nova",
        "Crescente",
        "Quarto Crescente",
        "Gibosa Crescente",
        "Lua Cheia",
        "Gibosa Minguante",
        "Quarto Minguante",
        "Minguante"
      ];

      const phaseName = phases[Math.floor(phase / 3.69) % phases.length];
      const lightPercent = Math.round(Math.pow(Math.sin(Math.PI * phase / 29.53), 2) * 100);

      return { phaseName, lightPercent };
    }

    form.addEventListener('submit', e => {
      e.preventDefault();
      resultado.textContent = 'A registar...';

      const nome = document.getElementById('nome').value.trim();
      const estado = document.getElementById('estado').value;

      if (!nome || !estado) {
        alert('Por favor, preencha todos os campos.');
        resultado.textContent = '';
        return;
      }

      if (!navigator.geolocation) {
        alert('Geolocalização não suportada no seu navegador.');
        resultado.textContent = '';
        return;
      }

      navigator.geolocation.getCurrentPosition(position => {
        const latitude = position.coords.latitude;
        const longitude = position.coords.longitude;

        const { phaseName, lightPercent } = getMoonPhase();

        const concelho = "Desconhecido"; // Aqui podes usar API se quiseres

        const dados = {
          nome,
          estado,
          latitude,
          longitude,
          faseLua: phaseName,
          percentagemLua: lightPercent,
          concelho
        };

        fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(dados)
        })
        .then(res => res.json())
        .then(json => {
          if (json.success) {
            resultado.textContent = `Registo efetuado com sucesso! Código: ${json.id}`;
            form.reset();
          } else {
            resultado.textContent = 'Erro ao registar. Tente novamente.';
          }
        })
        .catch(() => {
          resultado.textContent = 'Erro de comunicação com o servidor.';
        });

      }, () => {
        alert('Não foi possível obter a localização.');
        resultado.textContent = '';
      });
    });
  </script>
</body>
</html>
